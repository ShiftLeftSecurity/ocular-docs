# Finding previously unknown vulnerabilities by example (CVE-2018-20157)

This tutorial is about finding an XXE in [OpenRefine](https://github.com/OpenRefine/OpenRefine/). OpenRefine is an system [todo]

## Creating the CPG
OpenRefine does not come packaged into a single executable jar or war file as expected by `java2cpg`. Luckily, `java2cpg` is rather forgiving when it comes to JAR file structure: a zip file named "jar" containing the class files of interest is perfectly sufficient. We build this file as follows.

```
wget https://github.com/OpenRefine/OpenRefine/releases/download/3.1/openrefine-linux-3.1.tar.gz
tar xfz openrefine-linux-3.1.tar.gz
find openrefine-3.1 -name "*.class" | zip openrefine.jar -@
```
We then run `java2cpg`, specifying that we wish to include the application code from the namespaces `com.google.refine` and `org.openrefine` for this CPG.

```
./java2cpg.sh openrefine.jar -w com.google.refine,org.openrefine -nb -o openrefine.bin.zip
```

Finally, we load the newly created CPG into ocular

```
./ocular.sh
ocular> loadCpg("openrefine.bin.zip")
```

## Peering inside the application

XXE is strongly related to XML parser, thus we need to find some calls to them. First let's look if we find anything usefull containing XML. 

```
ocular> cpg.method.fullName(".*XML.*").fullName.toList.sorted
res50: List[String] = List(
  "com.google.refine.importers.XmlImporter.access$100:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "com.google.refine.importers.XmlImporter.descendElement:org.json.JSONObject(javax.xml.stream.XMLStreamReader,com.google.refine.importers.XmlImporter$PreviewParsingState)",
  "javax.xml.stream.XMLInputFactory.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "javax.xml.stream.XMLInputFactory.newInstance:javax.xml.stream.XMLInputFactory()",
  "javax.xml.stream.XMLInputFactory.setProperty:void(java.lang.String,java.lang.Object)",
  "javax.xml.stream.XMLStreamException.<init>:void(java.lang.String)",
  "javax.xml.stream.XMLStreamReader.getAttributeCount:int()",
  "javax.xml.stream.XMLStreamReader.getAttributeLocalName:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getAttributePrefix:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getAttributeValue:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getEventType:int()",
  "javax.xml.stream.XMLStreamReader.getLocalName:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.getNamespaceCount:int()",
  "javax.xml.stream.XMLStreamReader.getNamespacePrefix:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getNamespaceURI:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.getNamespaceURI:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getPrefix:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.getText:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.hasNext:boolean()",
  "javax.xml.stream.XMLStreamReader.next:int()",
  "org.apache.poi.POIXMLDocument.hasOOXMLHeader:boolean(java.io.InputStream)"
)
```

Not many methods but still to much noise for us. We can slice it down a bit.
```
ocular> cpg.method.fullName(".*XML.*").fullNameNot("(com.google|.*.(get|next|set|has)).*").fullName.toList.sorted
res57: List[String] = List(
  "javax.xml.stream.XMLInputFactory.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "javax.xml.stream.XMLInputFactory.newInstance:javax.xml.stream.XMLInputFactory()",
  "javax.xml.stream.XMLStreamException.<init>:void(java.lang.String)"
)
```
## 
