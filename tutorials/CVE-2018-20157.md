# Finding previously unknown vulnerabilities by example (CVE-2018-20157)

This tutorial is about finding an XXE in [OpenRefine](https://github.com/OpenRefine/OpenRefine/). 

OpenRefine is described by its authors as "a free, open source power tool for working with messy data and improving it". It is used, for example, by Journalists to clean up messy public data sets prior to statistical calculations. To enable this, it provides mechanisms for importing and exporting data, often split into multiple files or packed into archives.



## Creating the CPG
OpenRefine does not come packaged into a single executable jar or war file as expected by `java2cpg`. Luckily, `java2cpg` is rather forgiving when it comes to JAR file structure: a zip file named "jar" containing the class files of interest is perfectly sufficient. We build this file as follows.

```
wget https://github.com/OpenRefine/OpenRefine/releases/download/3.1/openrefine-linux-3.1.tar.gz
tar xfz openrefine-linux-3.1.tar.gz
find openrefine-3.1 -name "*.class" | zip openrefine.jar -@
```
We then run `java2cpg`, specifying that we wish to include the application code from the namespaces `com.google.refine` and `org.openrefine` for this CPG.

```
./java2cpg.sh openrefine.jar -w com.google.refine,org.openrefine -nb -o openrefine.bin.zip
```

Finally, we load the newly created CPG into ocular

```
./ocular.sh
loadCpg("openrefine.bin.zip")
```

## Peering inside the application aka. is it vulnerable?

XXE is strongly related to XML parser, thus we need to find some calls to them. First lets look if we find anything usefull containing XML. 

```
cpg.method.fullName(".*XML.*").fullName.toList.sorted
res50: List[String] = List(
  "com.google.refine.importers.XmlImporter.access$100:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "com.google.refine.importers.XmlImporter.descendElement:org.json.JSONObject(javax.xml.stream.XMLStreamReader,com.google.refine.importers.XmlImporter$PreviewParsingState)",
  "javax.xml.stream.XMLInputFactory.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "javax.xml.stream.XMLInputFactory.newInstance:javax.xml.stream.XMLInputFactory()",
  "javax.xml.stream.XMLInputFactory.setProperty:void(java.lang.String,java.lang.Object)",
  "javax.xml.stream.XMLStreamException.<init>:void(java.lang.String)",
  "javax.xml.stream.XMLStreamReader.getAttributeCount:int()",
  "javax.xml.stream.XMLStreamReader.getAttributeLocalName:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getAttributePrefix:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getAttributeValue:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getEventType:int()",
  "javax.xml.stream.XMLStreamReader.getLocalName:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.getNamespaceCount:int()",
  "javax.xml.stream.XMLStreamReader.getNamespacePrefix:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getNamespaceURI:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.getNamespaceURI:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getPrefix:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.getText:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.hasNext:boolean()",
  "javax.xml.stream.XMLStreamReader.next:int()",
  "org.apache.poi.POIXMLDocument.hasOOXMLHeader:boolean(java.io.InputStream)"
)
```

Even though we don't find many methods, we can slice it down a bit.
```
cpg.method.fullName(".*XML.*").fullNameNot("(com.google|.*.(get|next|set|has)).*").fullName.toList.sorted
res57: List[String] = List(
  "javax.xml.stream.XMLInputFactory.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "javax.xml.stream.XMLInputFactory.newInstance:javax.xml.stream.XMLInputFactory()",
  "javax.xml.stream.XMLStreamException.<init>:void(java.lang.String)"
)
```

Now it is is clear that we have to look for `XMLStreamReader`. [XMLStreamReader](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet#XMLInputFactory_.28a_StAX_parser.29) is one of the may vulnerable Java [XML parsing libraries](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet). With the countermessuares listed on the prevention cheat sheet page of OWASP, we know what we need to look for!

We need to be sure that these settings are not set: 
```
xmlInputFactory.setProperty(XMLInputFactory.SUPPORT_DTD, false); // This disables DTDs entirely for that factory
xmlInputFactory.setProperty("javax.xml.stream.isSupportingExternalEntities", false); // disable external entities
```

And we are lucky, the application only calls `isReplacingEntityReferences` and `isCoalescing`. Both methods are not mentioned in the cheat sheet and according to the [documetnation](https://docs.oracle.com/javase/8/docs/api/javax/xml/stream/XMLInputFactory.html) nor they are interfering with DTD settings.  
```
cpg.method.name("setProperty").fullName(".*XML.*").parameter.argument.literal.name.p
res79: List[String] = List("\"javax.xml.stream.isReplacingEntityReferences\"", "\"javax.xml.stream.isCoalescing\"")
```

With only two queries we have identified a vulnerable parts of the applications and missing counter messuares! The next step is about finding out if and how we can actually control the input!

## Identifying importers (sources)

We start looking for imports by looking for all methods that contain the substring "Import" in their method name. This search yields 502 methods, and is thus still a bit too generic.

```
cpg.method.fullName(".*Import.*").toList.size
res1: Int = 502
```

We narrow in on importers that we can access via HTTP by making use of a naming convention often found in [Java Servlet](https://en.wikipedia.org/wiki/Servlet) code: often HTTP Get handlers are named `doGet`, while HTTP POST handlers are named `doPost`. By executing the query below, the number of results is decreased to 13 methods, which we can easily review manually.

```
cpg.method.fullName(".*Import.*do(Get|Post).*").toList.size
res2: Int = 13
```

Some methods are stored in an interesting class with the name `DefaultImportingController`. We enhance our query by replacing `Import` with `DefaultImportingController`. The result consists, not surprisingly, of a `doGet` and a `doPost` method.
```
cpg.method.fullName(".*DefaultImportingController.*do(Get|Post).*").fullName.p

com.google.refine.importing.DefaultImportingController.doGet:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)
com.google.refine.importing.DefaultImportingController.doPost:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)
```

Looks like we found a interesting source and only used three queries! 

While we found the method we still need to create a source for the data flow. The query below defines a source and reduces the number of starting points to `HttpServletRequest` parameter of the variables. Sometimes the `HttpServletResponse` is also interesting but as we mentioned earlier, we start with the low hanging fruits. 

```
ocular> val source = cpg.method.fullName(".*DefaultImportingController.*do(Get|Post).*").parameter.evalType(".*HttpServletRequest.*")
```

Alright, we are done in this section and have a nice source and a good starting point.

## Looking for the sink
To find the sink we use the same query that we have used to list all methods containing `XML`. 

```
cpg.method.fullName(".*XML.*").fullName.toList.sorted
[..]
"javax.xml.stream.XMLStreamReader.next:int()",
[..]
```
We have removed all the "getter" and "setter" methods and all the methods not belonging to `javax.xml.stream` package. The method that is left is [next](https://docs.oracle.com/javase/7/docs/api/javax/xml/stream/XMLStreamReader.html#next\(\)).

The `next` method is described as
```
The next() method causes the reader to read the next parse event. 
```

This will result in the sink.
```
val sink = cpg.method.fullName(".*XMLStreamReader.*next.*").parameter
```
## Flows

Part 1
```
val source = cpg.method.fullName(".*DefaultImportingController.*do(Get|Post).*").parameter.evalType(".*HttpServletRequest.*")
val sink = cpg.method.fullName(".*createParserUIInitializationData.*").parameter
sink.reachableBy(source).flows.p

res162: List[String] = List(
  """ __________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
 | param     | type                                 | method                          | signature                                                                                                                                                                          |
 |=========================================================================================================================================================================================================================================================================|
 | request(1)| javax.servlet.http.HttpServletRequest| doPost                          | com.google.refine.importing.DefaultImportingController.doPost:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)                                   |
 | request   | javax.servlet.http.HttpServletRequest| doPost                          | com.google.refine.importing.DefaultImportingController.doPost:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)                                   |
 | request(1)| javax.servlet.http.HttpServletRequest| doInitializeParserUI            | com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)|
 | request   | javax.servlet.http.HttpServletRequest| doInitializeParserUI            | com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)|
 | this(0)   | javax.servlet.http.HttpServletRequest| getParameter                    | javax.servlet.http.HttpServletRequest.getParameter:java.lang.String(java.lang.String)                                                                                              |
 | param1(2) | ANY                                  | <operator>.assignment           | <operator>.assignment                                                                                                                                                              |
 | format    | java.lang.String                     | doInitializeParserUI            | com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)|
 | format    | java.lang.String                     | doInitializeParserUI            | com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)|
 | param2(3) | java.lang.String                     | createParserUIInitializationData| com.google.refine.importing.ImportingParser.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)         |
"""
)
```

Part 2
```
val source = cpg.method.fullName(".*Xml.*createParserUIInitializationData.*").parameter
val sink = cpg.method.fullName(".*XMLStreamReader.*next.*").parameter
sink.reachableBy(source).flows.p

______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
 | param         | type                                    | method                          | signature                                                                                                                                                               |
 |=====================================================================================================================================================================================================================================================================|
 | job(1)        | com.google.refine.importing.ImportingJob| createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)  |
 | job           | com.google.refine.importing.ImportingJob| createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)  |
 | job(1)        | com.google.refine.importing.ImportingJob| getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,org.json.JSONObject)                                       |
 | job           | com.google.refine.importing.ImportingJob| getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,org.json.JSONObject)                                       |
 | job(1)        | com.google.refine.importing.ImportingJob| getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                          |
 | job           | com.google.refine.importing.ImportingJob| getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                          |
 | this(0)       | com.google.refine.importing.ImportingJob| getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                   |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                   |
 | $r0           | java.io.File                            | getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                   |
 | $r0           | java.io.File                            | getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                   |
 | param0(1)     | java.io.File                            | <init>                          | java.io.File.<init>:void(java.io.File,java.lang.String)                                                                                                                 |
 | dir2          | java.io.File                            | getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                   |
 | dir2          | java.io.File                            | getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                   |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                   |
 | $r1           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                          |
 | $r1           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                          |
 | param0(1)     | java.io.File                            | <init>                          | java.io.File.<init>:void(java.io.File,java.lang.String)                                                                                                                 |
 | $r0           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                          |
 | $r0           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                          |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                   |
 | $r1           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,org.json.JSONObject)                                       |
 | $r1           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,org.json.JSONObject)                                       |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                   |
 | file          | java.io.File                            | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)  |
 | file          | java.io.File                            | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)  |
 | param0(1)     | java.io.File                            | <init>                          | java.io.FileInputStream.<init>:void(java.io.File)                                                                                                                       |
 | is            | java.io.FileInputStream                 | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)  |
 | is            | java.io.FileInputStream                 | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)  |
 | inputStream(1)| java.io.InputStream                     | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                     |
 | inputStream   | java.io.InputStream                     | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                     |
 | inputStream(1)| java.io.InputStream                     | wrapPrefixRemovingInputStream   | com.google.refine.importers.XmlImporter.wrapPrefixRemovingInputStream:java.io.InputStream(java.io.InputStream)                                                          |
 | inputStream   | java.io.InputStream                     | wrapPrefixRemovingInputStream   | com.google.refine.importers.XmlImporter.wrapPrefixRemovingInputStream:java.io.InputStream(java.io.InputStream)                                                          |
 | param0(1)     | java.io.InputStream                     | <init>                          | java.io.PushbackInputStream.<init>:void(java.io.InputStream)                                                                                                            |
 | pis           | java.io.PushbackInputStream             | wrapPrefixRemovingInputStream   | com.google.refine.importers.XmlImporter.wrapPrefixRemovingInputStream:java.io.InputStream(java.io.InputStream)                                                          |
 | pis           | java.io.PushbackInputStream             | wrapPrefixRemovingInputStream   | com.google.refine.importers.XmlImporter.wrapPrefixRemovingInputStream:java.io.InputStream(java.io.InputStream)                                                          |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                   |
 | $r2           | java.io.InputStream                     | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                     |
 | $r2           | java.io.InputStream                     | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                     |
 | param0(1)     | java.io.InputStream                     | createXMLStreamReader           | javax.xml.stream.XMLInputFactory.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                            |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                   |
 | $r3           | javax.xml.stream.XMLStreamReader        | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                     |
 | $r3           | javax.xml.stream.XMLStreamReader        | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                     |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                   |
 | parser        | javax.xml.stream.XMLStreamReader        | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)  |
 | parser        | javax.xml.stream.XMLStreamReader        | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)  |
 | parser(1)     | javax.xml.stream.XMLStreamReader        | descendElement                  | com.google.refine.importers.XmlImporter.descendElement:org.json.JSONObject(javax.xml.stream.XMLStreamReader,com.google.refine.importers.XmlImporter$PreviewParsingState)|
 | parser        | javax.xml.stream.XMLStreamReader        | descendElement                  | com.google.refine.importers.XmlImporter.descendElement:org.json.JSONObject(javax.xml.stream.XMLStreamReader,com.google.refine.importers.XmlImporter$PreviewParsingState)|
 | parser(1)     | javax.xml.stream.XMLStreamReader        | descendElement                  | com.google.refine.importers.XmlImporter.descendElement:org.json.JSONObject(javax.xml.stream.XMLStreamReader,com.google.refine.importers.XmlImporter$PreviewParsingState)|
 | parser        | javax.xml.stream.XMLStreamReader        | descendElement                  | com.google.refine.importers.XmlImporter.descendElement:org.json.JSONObject(javax.xml.stream.XMLStreamReader,com.google.refine.importers.XmlImporter$PreviewParsingState)|
 | this(0)       | javax.xml.stream.XMLStreamReader        | next                            | javax.xml.stream.XMLStreamReader.next:int()                                                                                                                             |
 ```
