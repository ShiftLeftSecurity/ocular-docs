# Finding previously unknown vulnerabilities by example (CVE-2018-20157)

This tutorial is about finding an XXE in [OpenRefine](https://github.com/OpenRefine/OpenRefine/). 

[OpenRefine](https://github.com/OpenRefine/OpenRefine/) is described by its
authors as *"a free, open source power tool for working with messy data and
improving it"*. A common use-case for OpenRefine is the sanitization of messy
public data sets prior to statistical calculations for which it provides
features such as importing and exporting of data which may be scattered among
multiple files or archives.


## Creating the CPG
OpenRefine is not distributed via a single JAR file as expected by `java2cpg`.
However, `java2cpg` does not require its input file to comply with a certain
file structure as long as its input is provided in ZIP format which is basically
equivalent to a JAR archive: a ZIP file with a `.jar` suffix containing the
`.class` files of interest is sufficient. Based on the OpenRefine sources, which
you can download as `.tar.gz` archive, we can prepare the `.jar` for `java2cpg`
by executing:

```
wget https://github.com/OpenRefine/OpenRefine/releases/download/3.1/openrefine-linux-3.1.tar.gz
tar xfz openrefine-linux-3.1.tar.gz
find openrefine-3.1 -name "*.class" | zip openrefine.jar -@
```

We then run `java2cpg` with the `-w` flag followed by a comma-separated list of
package-names (`com.google.refine`, `org.openrefine`) to be included in the CPG;
only the parts of the application with the package prefixes `com.google.refine`
and `org.openrefine` are included in the CPG. For relatively large applications
such as OpenRefine, focusing on certain application parts can save computing and
analysis time.

```
./java2cpg.sh openrefine.jar -w com.google.refine,org.openrefine -nb -o openrefine.bin.zip
```

Finally, we load the newly created CPG into ocular

```
./ocular.sh
loadCpg("openrefine.bin.zip")
```

## Peering inside the application aka. is it vulnerable?

XXE is strongly related to XML parsing; hence, it makes sense to search for program statemets related to XML parsing. As a first approximation, with the search query below, we are looking for all the methods that carry `XML` in their fully qualified name. 

```
cpg.method.fullName(".*XML.*").fullName.toList.sorted
res50: List[String] = List(
  "com.google.refine.importers.XmlImporter.access$100:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "com.google.refine.importers.XmlImporter.descendElement:org.json.JSONObject(javax.xml.stream.XMLStreamReader,com.google.refine.importers.XmlImporter$PreviewParsingState)",
  "javax.xml.stream.XMLInputFactory.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "javax.xml.stream.XMLInputFactory.newInstance:javax.xml.stream.XMLInputFactory()",
  "javax.xml.stream.XMLInputFactory.setProperty:void(java.lang.String,java.lang.Object)",
  "javax.xml.stream.XMLStreamException.<init>:void(java.lang.String)",
  "javax.xml.stream.XMLStreamReader.getAttributeCount:int()",
  "javax.xml.stream.XMLStreamReader.getAttributeLocalName:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getAttributePrefix:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getAttributeValue:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getEventType:int()",
  "javax.xml.stream.XMLStreamReader.getLocalName:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.getNamespaceCount:int()",
  "javax.xml.stream.XMLStreamReader.getNamespacePrefix:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getNamespaceURI:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.getNamespaceURI:java.lang.String(int)",
  "javax.xml.stream.XMLStreamReader.getPrefix:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.getText:java.lang.String()",
  "javax.xml.stream.XMLStreamReader.hasNext:boolean()",
  "javax.xml.stream.XMLStreamReader.next:int()",
  "org.apache.poi.POIXMLDocument.hasOOXMLHeader:boolean(java.io.InputStream)"
)
```

We can further narrow down this list by excluding certain patterns by means of the `fullNamenNot` filter:
```
cpg.method.fullName(".*XML.*").fullNameNot("(com.google|.*.(get|next|set|has)).*").fullName.toList.sorted
res57: List[String] = List(
  "javax.xml.stream.XMLInputFactory.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)",
  "javax.xml.stream.XMLInputFactory.newInstance:javax.xml.stream.XMLInputFactory()",
  "javax.xml.stream.XMLStreamException.<init>:void(java.lang.String)"
)
```

Since we are interested in XXE, and knowing that the [XMLStreamReader](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet#XMLInputFactory_.28a_StAX_parser.29) is one of the many vulnerable Java [XML parsing libraries](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet), we may have found a possible a weak spot. Based on the countermeasures listed on the prevention cheat sheet page of OWASP, we know how to check whether the
OpenRefine developers developed the proper precautions to prevent possible exploits. To get a clue whether our XXE is exploitable,
we can check whether the following propreties are *not* set:

```
xmlInputFactory.setProperty(XMLInputFactory.SUPPORT_DTD, false); // This disables DTDs entirely for that factory
xmlInputFactory.setProperty("javax.xml.stream.isSupportingExternalEntities", false); // disable external entities
```

As illustrated below, the properties mentioned above are not set in the application; only the properties `isReplacingEntityReferences` and `isCoalescing` are set neither of which is relevant when it comes to the prevention of XXE.
```
cpg.method.name("setProperty").fullName(".*XML.*").parameter.argument.literal.name.p
res79: List[String] = List("\"javax.xml.stream.isReplacingEntityReferences\"", "\"javax.xml.stream.isCoalescing\"")
```

With only two queries we have identified a weak spot in OpenRefine. Now we have to figure out from where data can flow to the weak spot and whether an attacker may be able to control it.

## Identifying importers (sources)

Input sources represent program points where potentially malicious
(attacker-controlled) data may enter the system. In this section, we will show
how to search and define an input source with ocular.

As mentioned in the introduction, OpenRefine relies on importing and exporting
data. Hence, as a first guess, it may be a good idea to look for imports. We can
do this by looking for all methods that contain the substring `Import` in their
full method name. By applying this search strategy, we can find 502 methods
which is a too large number of methods to be inspected manually. Hence, we have
to make our search filter more specific in order to further narrow down the list.

```
cpg.method.fullName(".*Import.*").toList.size
res1: Int = 502
```
Based on naming convention often found in [Java
Servlet](https://en.wikipedia.org/wiki/Servlet) code, we can narrow down the
list of methods by including only methods accessible via HTTP through the
addition of `do(Get|Post)` to our search pattern: HTTP Get handlers are named
`doGet`, while HTTP POST handlers are named `doPost`. By executing the query
below, the number of results is decreased to only 13 methods, a small enough number
to be inspected manually.

```
cpg.method.fullName(".*Import.*do(Get|Post).*").toList.size
res2: Int = 13
```

Some methods are stored in a class with the name `DefaultImportingController`
which, as suggested by its name, may be interesting from a security standpoint.
We enhance our query by replacing `Import` with `DefaultImportingController`.
The new search result consists of a `doGet` and a `doPost` method.

```
cpg.method.fullName(".*DefaultImportingController.*do(Get|Post).*").fullName.p

com.google.refine.importing.DefaultImportingController.doGet:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)
com.google.refine.importing.DefaultImportingController.doPost:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)
```

Based on these results, we have found a source as starting point for our
security analysis by only issuing three queries. The query below defines a
source by applying our search filter. To be more specific, we also
specify the required type of the parameters (which is `HttpServletRequest`).

```
val source = cpg.method.fullName(".*DefaultImportingController.*do(Get|Post).*").parameter.evalType(".*HttpServletRequest.*")
```


## Looking for the sink
To find the sink, we use the same query that we have used to list all the methods containing `XML`. 

```
cpg.method.fullName(".*XML.*").fullName.toList.sorted
[..]
"javax.xml.stream.XMLStreamReader.next:int()",
[..]
```
Afer removing all the "getter" and "setter" methods and all the methods not belonging to `javax.xml.stream` package, the only one left is [next](https://docs.oracle.com/javase/7/docs/api/javax/xml/stream/XMLStreamReader.html#next\(\)) which is described as:

```
The next() method causes the reader to read the next parse event. 
```

So we can define the sink with:
```
val sink = cpg.method.fullName(".*XMLStreamReader.*next.*").parameter
```
## Vulnerable flows

Unfortunatly we cannot find a direct flows between these data flow, we need some research about why this is happening. We can start by manually traversing the call stack, using the `caller` step. The first layer of caller shows us an interesting method `createParserUIInitializationData`, which consumes an `ImportingJob`. 

```
cpg.method.fullName(".*XMLStreamReader.*next.*").caller.fullName.p 
res11: List[String] = List(  "com.google.refine.importers.XmlImporter$XmlParser.next:com.google.refine.importers.tree.TreeReader$Token()",
  "com.google.refine.importers.XmlImporter.descendElement:org.json.JSONObject(javax.xml.stream.XMLStreamReader,com.google.refine.importers.XmlImporter$PreviewParsingState)",  "com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)"
)
```

We can restrict the caller by `name` and `fullName` as we have done it for regular method filter and we see that there is only one other importer showing up, a `MarcImporter`. The MarcImporter does not have any caller. It is a godd guess that the importers implement an interface, because of the similar method signatures.  
```
cpg.method.fullName(".*XMLStreamReader.*next.*").caller.fullName(".*createParserUIInitializationData.*").caller.fullName.p res13: List[String] = List("com.google.refine.importers.MarcImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)")

cpg.method.fullName(".*XMLStreamReader.*next.*").caller.fullName(".*createParserUIInitializationData.*").caller.caller.fullName.p res14: List[String] = List()
```

We can easily check our guess by listing the implementing classes and interfaces of a class. `typeDecl` is the class we filter by name and `baseTypeDeclTransitive` is the supertype, we traverse the class hierachy to get this information. The last query shows that both share a common interface `ImportingParser` and implement the corresponding method `createParserUIInitializationData`!

```
cpg.typeDecl.name("XmlImporter").baseTypeDeclTransitive.name.p 
res19: List[String] = List("TreeImportingParserBase", "ImportingParserBase", "Object", "ImportingParser", "Object")

cpg.typeDecl.name("MarcImporter").baseTypeDeclTransitive.name.p 
res20: List[String] = List("XmlImporter", "TreeImportingParserBase", "ImportingParserBase", "Object", "ImportingParser", "Object")

cpg.typeDecl.name("ImportingParser").method.fullName.p 
res23: List[String] = List(
  "com.google.refine.importing.ImportingParser.parse:void(com.google.refine.model.Project,com.google.refine.model.metadata.ProjectMetadata,com.google.refine.importing.ImportingJob,java.util.List,java.lang.String,int,org.json.JSONObject,java.util.List)",
  "com.google.refine.importing.ImportingParser.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)"
)

```

We found our way up from the sink to an interface call but is it really used by our source we found? Even if the application uses an interface call, that decamps the call chain, it still needs to call the exact method name, `createParserUIInitializationData`. We can start from this method and also manually traverse the call stack to find our source. Our `DefaultImportingController` is only two calls away!

```
cpg.method.name("createParserUIInitializationData").caller.fullName.p  
res37: List[String] = List(  
[..]
"com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)",  
[..]

cpg.method.name("createParserUIInitializationData").caller.fullName(".*Default.*Import.*").fullName.p res38: List[String] = List("com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)")ocular> 

cpg.method.name("createParserUIInitializationData").caller.fullName(".*Default.*Import.*").caller.fullName.p 
res39: List[String] = List("com.google.refine.importing.DefaultImportingController.doPost:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)")
```


We reuse our previously found source and our new sink to find the first part of the vulnerable flow. 
```
val source = cpg.method.fullName(".*DefaultImportingController.*do(Get|Post).*").parameter.evalType(".*HttpServletRequest.*")
val sink = cpg.method.fullName(".*createParserUIInitializationData.*").parameter
sink.reachableBy(source).flows.p

res162: List[String] = List(
  """ __________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
 | param     | type                                 | method                          | signature                                                                                                                                                                          |
 |=========================================================================================================================================================================================================================================================================|
 | request(1)| javax.servlet.http.HttpServletRequest| doPost                          | com.google.refine.importing.DefaultImportingController.doPost:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)                                   |
 | request   | javax.servlet.http.HttpServletRequest| doPost                          | com.google.refine.importing.DefaultImportingController.doPost:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)                                   |
 | request(1)| javax.servlet.http.HttpServletRequest| doInitializeParserUI            | com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)|
 | request   | javax.servlet.http.HttpServletRequest| doInitializeParserUI            | com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)|
 | this(0)   | javax.servlet.http.HttpServletRequest| getParameter                    | javax.servlet.http.HttpServletRequest.getParameter:java.lang.String(java.lang.String)                                                                                              |
 | param1(2) | ANY                                  | <operator>.assignment           | <operator>.assignment                                                                                                                                                              |
 | format    | java.lang.String                     | doInitializeParserUI            | com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)|
 | format    | java.lang.String                     | doInitializeParserUI            | com.google.refine.importing.DefaultImportingController.doInitializeParserUI:void(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse,java.util.Properties)|
 | param2(3) | java.lang.String                     | createParserUIInitializationData| com.google.refine.importing.ImportingParser.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)         |
"""
)
```

For the second part we start from the `createParserUIInitializationData` method but it should contain `Xml` in the fullName. The sink is our previously described `next` method, the result is the following flow.

```
val source = cpg.method.fullName(".*Xml.*createParserUIInitializationData.*").parameter
val sink = cpg.method.fullName(".*XMLStreamReader.*next.*").parameter
sink.reachableBy(source).flows.p

 ____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
 | param         | type                                    | method                          | signature                                                                                                                                                             |
 |===================================================================================================================================================================================================================================================================|
 | job(1)        | com.google.refine.importing.ImportingJob| createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)|
 | job           | com.google.refine.importing.ImportingJob| createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)|
 | job(1)        | com.google.refine.importing.ImportingJob| getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,org.json.JSONObject)                                     |
 | job           | com.google.refine.importing.ImportingJob| getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,org.json.JSONObject)                                     |
 | job(1)        | com.google.refine.importing.ImportingJob| getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                        |
 | job           | com.google.refine.importing.ImportingJob| getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                        |
 | this(0)       | com.google.refine.importing.ImportingJob| getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                 |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                 |
 | $r0           | java.io.File                            | getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                 |
 | $r0           | java.io.File                            | getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                 |
 | param0(1)     | java.io.File                            | <init>                          | java.io.File.<init>:void(java.io.File,java.lang.String)                                                                                                               |
 | dir2          | java.io.File                            | getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                 |
 | dir2          | java.io.File                            | getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                 |
 | ret(ret)      | java.io.File                            | getRawDataDir                   | com.google.refine.importing.ImportingJob.getRawDataDir:java.io.File()                                                                                                 |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                 |
 | $r1           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                        |
 | $r1           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                        |
 | param0(1)     | java.io.File                            | <init>                          | java.io.File.<init>:void(java.io.File,java.lang.String)                                                                                                               |
 | $r0           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                        |
 | $r0           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                        |
 | ret(ret)      | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,java.lang.String)                                        |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                 |
 | $r1           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,org.json.JSONObject)                                     |
 | $r1           | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,org.json.JSONObject)                                     |
 | ret(ret)      | java.io.File                            | getFile                         | com.google.refine.importing.ImportingUtilities.getFile:java.io.File(com.google.refine.importing.ImportingJob,org.json.JSONObject)                                     |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                 |
 | file          | java.io.File                            | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)|
 | file          | java.io.File                            | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)|
 | param0(1)     | java.io.File                            | <init>                          | java.io.FileInputStream.<init>:void(java.io.File)                                                                                                                     |
 | is            | java.io.FileInputStream                 | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)|
 | is            | java.io.FileInputStream                 | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)|
 | inputStream(1)| java.io.InputStream                     | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                   |
 | inputStream   | java.io.InputStream                     | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                   |
 | inputStream(1)| java.io.InputStream                     | wrapPrefixRemovingInputStream   | com.google.refine.importers.XmlImporter.wrapPrefixRemovingInputStream:java.io.InputStream(java.io.InputStream)                                                        |
 | inputStream   | java.io.InputStream                     | wrapPrefixRemovingInputStream   | com.google.refine.importers.XmlImporter.wrapPrefixRemovingInputStream:java.io.InputStream(java.io.InputStream)                                                        |
 | param0(1)     | java.io.InputStream                     | <init>                          | java.io.PushbackInputStream.<init>:void(java.io.InputStream)                                                                                                          |
 | pis           | java.io.PushbackInputStream             | wrapPrefixRemovingInputStream   | com.google.refine.importers.XmlImporter.wrapPrefixRemovingInputStream:java.io.InputStream(java.io.InputStream)                                                        |
 | pis           | java.io.PushbackInputStream             | wrapPrefixRemovingInputStream   | com.google.refine.importers.XmlImporter.wrapPrefixRemovingInputStream:java.io.InputStream(java.io.InputStream)                                                        |
 | ret(ret)      | java.io.InputStream                     | wrapPrefixRemovingInputStream   | com.google.refine.importers.XmlImporter.wrapPrefixRemovingInputStream:java.io.InputStream(java.io.InputStream)                                                        |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                 |
 | $r2           | java.io.InputStream                     | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                   |
 | $r2           | java.io.InputStream                     | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                   |
 | param0(1)     | java.io.InputStream                     | createXMLStreamReader           | javax.xml.stream.XMLInputFactory.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                          |
 | ret(ret)      | javax.xml.stream.XMLStreamReader        | createXMLStreamReader           | javax.xml.stream.XMLInputFactory.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                          |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                 |
 | $r3           | javax.xml.stream.XMLStreamReader        | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                   |
 | $r3           | javax.xml.stream.XMLStreamReader        | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                   |
 | ret(ret)      | javax.xml.stream.XMLStreamReader        | createXMLStreamReader           | com.google.refine.importers.XmlImporter.createXMLStreamReader:javax.xml.stream.XMLStreamReader(java.io.InputStream)                                                   |
 | param1(2)     | ANY                                     | <operator>.assignment           | <operator>.assignment                                                                                                                                                 |
 | parser        | javax.xml.stream.XMLStreamReader        | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)|
 | parser        | javax.xml.stream.XMLStreamReader        | createParserUIInitializationData| com.google.refine.importers.XmlImporter.createParserUIInitializationData:org.json.JSONObject(com.google.refine.importing.ImportingJob,java.util.List,java.lang.String)|
 | this(0)       | javax.xml.stream.XMLStreamReader        | next                            | javax.xml.stream.XMLStreamReader.next:int()                                                                                                                           |
 ```

## Conclusion

Eventually we manged to get around the indirect calls by quering the call hirachy and the call stack. Everything was done inside ocular with some intuation and eventually we managed to exploit the XXE vulnerability and get `CVE-2018-20157`!
